# 給与明細マッピング機能 取扱説明書

## 概要
給与明細システムにおけるCSVマッピング機能の使用方法と仕様について説明します。

## 基本機能

### 1. マッピング設定の固定化機能
**2025年8月実装**: 過去の給与明細の項目名を保護する機能

#### 機能概要
- **過去の明細**: アップロード時のマッピング設定で表示（固定）
- **新規明細**: 最新のマッピング設定で表示
- **再アップロード**: 新しいマッピング設定で更新

#### 動作仕様
```
マッピング変更前: 「基本給」→「基本給」で表示
マッピング変更後: 「基本給」→「基本給」で表示（変わらない）
新規アップロード: 「基本給」→「月給」で表示（新設定適用）
```

## 使用方法

### 1. 初回CSVアップロード
1. **CSVマッピング設定**
   - 従業員管理 → CSV設定 → マッピング設定
   - 各項目を適切にマッピング

2. **CSVファイルアップロード**
   - CSV管理 → ファイルアップロード
   - アップロード時点のマッピング設定が給与明細に保存される

3. **給与明細確認**
   - 設定した項目名で表示される

### 2. マッピング設定の変更
1. **設定変更**
   - CSVマッピング設定で項目名を変更
   - 例: 「基本給」→「月給」に変更

2. **既存明細への影響**
   - **影響なし**: 過去の明細は変更前の項目名のまま
   - 「基本給」として表示され続ける

3. **新規アップロード**
   - 新しいCSVをアップロードすると新設定が適用
   - 「月給」として表示される

### 3. 明細の再作成
**完全に新しいマッピングで作成したい場合:**

1. **古い明細の削除**（管理者のみ）
   - 給与明細一覧 → 削除ボタン

2. **マッピング設定の変更**
   - 新しい項目名に設定

3. **CSVの再アップロード**
   - 新しいマッピング設定で明細が作成される

## 技術仕様

### データ構造
```javascript
// 給与明細データ（Firestore）
{
  employeeId: "001",
  paymentDate: "2025-08-01",
  items: { "基本給": 250000, ... },
  
  // 新機能: アップロード時のマッピング設定
  originalMapping: {
    incomeItems: [
      { headerName: "基本給", itemName: "基本給", ... }
    ],
    deductionItems: [...],
    attendanceItems: [...],
    timestamp: "2025-08-01T10:00:00Z"
  }
}
```

### 表示ロジック
```javascript
// 表示時の判定
if (payslipData.originalMapping) {
  // 保存済みマッピングを使用（過去の明細）
  currentMappingConfig = payslipData.originalMapping;
} else {
  // 現在のマッピング設定を使用（既存データ互換性）
  currentMappingConfig = getCurrentMapping();
}
```

## 運用上の注意事項

### 1. マッピング変更のタイミング
- **推奨**: 新しい給与明細作成前に変更
- **注意**: 変更後は過去明細と新規明細で項目名が異なる

### 2. データの一貫性
- **過去明細**: 変更されず一貫性保持
- **新規明細**: 最新設定で統一

### 3. バックアップの重要性
- マッピング設定変更前にデータのバックアップを推奨
- 管理画面のデータバックアップ機能を使用

## トラブルシューティング

### Q1: 過去の明細の項目名を変更したい
**A**: 以下の方法があります：
1. **推奨**: 明細を削除して再アップロード
2. **非推奨**: Firebase Consoleで直接編集（技術的知識必要）

### Q2: 新規明細が古いマッピングで表示される
**A**: 以下を確認してください：
1. マッピング設定が正しく保存されているか
2. CSVアップロードが正常に完了しているか
3. ブラウザのキャッシュをクリア

### Q3: 既存明細が表示されない
**A**: システムの互換性機能により自動対応されます：
- `originalMapping`がない既存データは現在の設定で表示

## システム更新履歴

### 2025年8月5日 - マッピング固定化機能実装
- **追加機能**: 
  - 給与明細データにマッピング設定保存
  - 表示時の設定優先順位制御
  - 既存データ互換性確保

- **変更ファイル**:
  - `functions/index.js`: マッピング保存処理
  - `src/pages/PayslipDetail.js`: 表示制御ロジック

- **効果**:
  - 過去明細の項目名保護
  - マッピング変更の自由度向上
  - データ整合性確保

## セキュリティ考慮事項

### データ保護
- マッピング設定は給与明細と同じセキュリティレベルで保護
- 管理者のみがマッピング設定を変更可能
- 従業員は自分の明細のみ閲覧可能

### アクセス制御
- マッピング設定変更: 管理者権限必要
- 明細削除: 管理者権限必要
- 明細閲覧: 本人または管理者のみ

## 関連ドキュメント
- [CLAUDE.md](./CLAUDE.md): システム全体の引継ぎ資料
- [README.md](./README.md): プロジェクト概要
- Firebase Console: データベース直接確認

---
**作成日**: 2025年8月5日  
**作成者**: Claude Code Assistant  
**最終更新**: 2025年8月5日