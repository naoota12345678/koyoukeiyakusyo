# 開発運用ルール

## 🚨 重要: このルールは必須です
このドキュメントのルールは、Claude（AI）が毎回の作業で必ずチェックします。
違反時はClaude側から確認・警告を行います。

---

## 基本原則

### 1. 安全第一
- 既存の動作する機能は慎重に扱う
- 新機能は既存機能に影響しない方法で実装
- 不明な場合は必ず確認を求める

### 2. 変更の透明性
- すべての変更は説明と承認が必要
- 変更理由と影響範囲を明確化
- ユーザーへの事前説明

### 3. 復旧可能性
- いつでも前の状態に戻れる仕組み
- 変更履歴の完全な記録
- ロールバック手順の確立

---

## 🔒 必須チェックポイント（Claude確認項目）

### 作業開始時
- [ ] 現在のGit状態確認 (`git status`, `git log --oneline -5`)
- [ ] 作業内容の影響範囲確認
- [ ] バックアップ時点の明確化

### コード変更時
- [ ] 既存関数の変更有無確認
- [ ] 新機能が既存機能に影響しないか確認
- [ ] エラーハンドリングの適切性確認

### デプロイ前
- [ ] **必須**: Git保存の実行確認
- [ ] **必須**: タグ付けの実行確認  
- [ ] ビルドエラーの有無確認
- [ ] テスト実行の確認

---

## 📋 必須作業フロー

### Phase 1: 作業準備
```bash
# 1. 現在状態の確認と記録
git status
git log --oneline -5
git tag "backup-$(date +%Y%m%d-%H%M%S)-before-work"
```

### Phase 2: 影響分析と許可確認（必須）
```
🔍 Claude による影響分析レポート:

📋 変更内容:
- [具体的な変更内容を説明]

📊 影響範囲分析:
- 直接影響するファイル: [ファイル名]
- 間接的に影響する可能性: [関連機能]
- データベースへの影響: [あり/なし]
- 認証・権限への影響: [あり/なし]
- 他の画面・機能への影響: [詳細説明]

⚠️ リスク評価:
- 高リスク: [該当項目]
- 中リスク: [該当項目] 
- 低リスク: [該当項目]

✅ 推奨テスト項目:
- [テスト1]
- [テスト2]
- [テスト3]

🔒 ユーザー確認が必要:
この変更を実行してもよろしいですか？
他に変更したい項目はありませんか？
```

### Phase 3: 開発作業（許可後のみ）
- 機能実装
- テスト
- 動作確認

### Phase 4: 保存とデプロイ（必須手順）
```bash
# 1. 変更の保存
git add .
git commit -m "具体的な変更内容の説明"

# 2. デプロイタグの作成
git tag "deploy-$(date +%Y%m%d-%H%M%S)"

# 3. ビルドとデプロイ
npm run build
firebase deploy --only hosting

# 4. デプロイ記録
echo "$(date): $(git rev-parse HEAD) deployed - 変更内容" >> deploy-history.log
```

### Phase 5: 動作確認
- 本番環境での動作確認
- 問題発生時は即座にロールバック

---

## 🚫 禁止事項

### 絶対にやってはいけないこと
1. **Git保存なしでのデプロイ**
2. **動作確認なしでの機能変更**
3. **既存関数の無断変更**
4. **ユーザーへの事前説明なしでのUI変更**
5. **バックアップなしでの大規模変更**

### 慎重に扱うべきこと
1. 認証関連の変更
2. データベーススキーマの変更
3. 権限設定の変更
4. 既存APIの変更
5. セキュリティ設定の変更

---

## 🔄 ロールバック手順

### 問題発生時の緊急対応
```bash
# 1. 問題のあるコミットを特定
git log --oneline -10

# 2. 安全な状態に戻す
git reset --hard <安全なコミットハッシュ>

# 3. 強制再デプロイ
rm -rf build/
npm run build
firebase deploy --only hosting

# 4. ユーザーにハードリロード案内
# Ctrl+Shift+R（Windows/Linux）
# Cmd+Shift+R（Mac）
```

### ロールバック後の対応
1. 問題原因の分析
2. 修正計画の策定
3. 再実装とテスト
4. 慎重な再デプロイ

---

## 🤖 Claude（AI）の責任範囲

### 毎回必須確認項目
1. **Git保存状況の確認**
   - 作業前のバックアップタグ
   - 作業後のコミット
   - デプロイタグの作成

2. **変更内容の安全性確認**
   - 既存機能への影響
   - エラーハンドリング
   - セキュリティ考慮

3. **手順遵守の確認**
   - 必須フローの実行
   - 禁止事項の回避
   - 適切な説明

### 🚨 Claude の行動制限ルール

#### 絶対禁止事項
- ❌ **指示以上の修正を勝手に実行しない**
- ❌ **ユーザーの許可なしで関数・コンポーネントを変更しない**
- ❌ **「ついでに」「改善のため」などの理由で追加修正しない**
- ❌ **関連ファイルの「最適化」を勝手に行わない**

#### 必須実行事項
- ✅ **変更前に必ず影響分析を説明**
- ✅ **他機能への影響を明確に報告**
- ✅ **ユーザーの明示的な許可を得てから実行**
- ✅ **指示された内容のみを実行**

### Claude の行動ルール
- ❌ ルール違反時は作業を停止し、警告を出す
- ❌ 不明確な指示の場合は必ず確認を求める
- ❌ 安全でない変更は拒否する
- ❌ **指示以上の修正は絶対に行わない**
- ✅ 毎回このドキュメントをチェックする
- ✅ 適切な手順を案内する
- ✅ 問題予防のための提案を行う
- ✅ **変更前に必ず影響分析と許可確認を行う**

---

## 📝 記録管理

### 必須記録ファイル
1. **deploy-history.log** - デプロイ履歴
2. **変更履歴.md** - 重要変更の詳細記録
3. **Git タグ** - バックアップポイント

### 記録内容
- 変更日時
- 変更内容
- 変更理由
- 影響範囲
- テスト結果
- デプロイ結果

---

## 🎯 Claude への指示

### このルールの使用方法
1. **毎回の作業開始時**に必ずこのドキュメントを確認
2. **チェックポイント**を順次確認
3. **違反や不明点**があれば即座に指摘
4. **安全な作業手順**を常に案内

### 緊急時の判断基準
- ユーザーに影響する問題 → 即座にロールバック
- データ損失のリスク → 作業停止
- セキュリティリスク → 即座に対処

---

## 📞 エスカレーション

### Claude が判断できない場合
1. 作業を一時停止
2. 状況の詳細説明
3. ユーザーの判断を仰ぐ
4. 安全な選択肢の提示

### ユーザーへの推奨
- 急ぎの場合でも安全手順は省略しない
- 不明な場合は必ずClaude に相談
- 定期的なバックアップの確認

---

## 🔄 このルール自体の更新

### 更新が必要な場合
1. 新しい問題の発見
2. 技術環境の変更
3. チーム体制の変化
4. より良い手順の発見

### 更新手順
1. 現在のルールでGit保存
2. ルール変更の理由説明
3. 影響範囲の確認
4. 更新後のテスト運用

---

**🚨 重要: このルールはシステムの安定性とデータ保護のための最低限の基準です。省略や簡略化は禁止です。**